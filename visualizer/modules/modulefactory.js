define(["jquery","modules/module","src/util/debug"],function(a,b,c){function d(b){return a.getJSON(require.toUrl(b),{}).pipe(function(a){return e(a)})}function e(b){var c=[];for(var e in b.folders)!function(a){if("object"==typeof b.folders[a]){var e=b.folders[a];delete b.folders[a],b.folders[e.name||a]=e}else c.push(d(b.folders[a]+"folder.json").done(function(c){delete b.folders[a],b.folders[c.name]=c}))}(e);return a.when.apply(a,c).pipe(function(){return b})}function f(b){return new Promise(function(d){var e={folders:{}};a.getJSON(require.toUrl(b+"/folder.json")).then(function(a){if(e.name=a.name,e.modules=a.modules,a.folders&&a.folders instanceof Array){for(var g=[],h=0;h<a.folders.length;h++)g.push(f(b+"/"+a.folders[h]));Promise.all(g).then(function(a){for(var b=0;b<a.length;b++){var c=a[b];e.folders[c.name]=c}d(e)},function(a){c.error("Caught error in ModuleFactory",a)})}else"object"==typeof a.folders&&(e.folders=a.folders),d(e)})})}var g,h=0,i=[],j=new DataArray,k=[];return{getTypes:function(){return a.when.apply(a,k).pipe(function(){return g})},setModules:function(b){if(b instanceof Array)return this.oldSetModules(b);if(b.folders instanceof Array){var d={};b.modules&&(d.modules=b.modules),d.folders={};for(var e=0;e<b.folders.length;e++)if("object"==typeof b.folders[e]){var h=b.folders[e];a.extend(!0,d.folders,h.folders)}else f(b.folders[e]).then(function(b){a.extend(!0,d,b)},function(a){c.error("Caught error in ModuleFactory",a)});g=d}else g=b},oldSetModules:function(b){var c,f=0;if(!(b instanceof Array))return void(g=b);c=b.length;for(var h={};c>f;f++)"string"==typeof b[f]?!function(c){d(b[c]).then(function(b){a.extend(!0,h,b)})}(f):e(b[f]).then(function(b){a.extend(!0,h,b)});g=h},newModule:function(a){var c=new b(a);return c.setId(++h),i.push(c),j.push(a),c},removeModule:function(a){i.splice(i.indexOf(a),1),j.splice(j.indexOf(a.definition),1)},empty:function(){j=new DataArray,i=[]},getModules:function(){return i},getDefinitions:function(){return j}}});